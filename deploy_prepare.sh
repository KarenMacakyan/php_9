#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ QloApps –∫ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—é –Ω–∞ —Ö–æ—Å—Ç–∏–Ω–≥–µ
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: ./deploy_prepare.sh

echo "========================================="
echo "  –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ QloApps –∫ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—é"
echo "========================================="
echo ""

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ —Å–∫—Ä–∏–ø—Ç –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∏–∑ –∫–æ—Ä–Ω—è –ø—Ä–æ–µ–∫—Ç–∞
if [ ! -f "config/config.inc.php" ]; then
    echo -e "${RED}–û—à–∏–±–∫–∞: –°–∫—Ä–∏–ø—Ç –¥–æ–ª–∂–µ–Ω –∑–∞–ø—É—Å–∫–∞—Ç—å—Å—è –∏–∑ –∫–æ—Ä–Ω–µ–≤–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ QloApps${NC}"
    exit 1
fi

# –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –¥–ª—è –¥–µ–ø–ª–æ—è
DEPLOY_DIR="qloapps_deploy_$(date +%Y%m%d_%H%M%S)"
echo -e "${YELLOW}–°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –¥–ª—è –¥–µ–ø–ª–æ—è: ${DEPLOY_DIR}${NC}"
mkdir -p "../${DEPLOY_DIR}"

# –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ (–∏—Å–∫–ª—é—á–∞—è –Ω–µ–Ω—É–∂–Ω—ã–µ)
echo -e "${YELLOW}–ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤...${NC}"
rsync -av --progress \
    --exclude='.git' \
    --exclude='.gitignore' \
    --exclude='.DS_Store' \
    --exclude='node_modules' \
    --exclude='*.log' \
    --exclude='cache/smarty/cache/*' \
    --exclude='cache/smarty/compile/*' \
    --exclude='config/settings.inc.php' \
    --exclude='config/defines.inc.php' \
    --exclude='img/p/*' \
    --exclude='img/c/*' \
    --exclude='download/*' \
    --exclude='upload/*' \
    --exclude='.htaccess' \
    --exclude='robots.txt' \
    ./ "../${DEPLOY_DIR}/"

# –°–æ–∑–¥–∞–Ω–∏–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –ø—É—Å—Ç—ã—Ö –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π
echo -e "${YELLOW}–°–æ–∑–¥–∞–Ω–∏–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π...${NC}"
mkdir -p "../${DEPLOY_DIR}/cache/smarty/cache"
mkdir -p "../${DEPLOY_DIR}/cache/smarty/compile"
mkdir -p "../${DEPLOY_DIR}/log"
mkdir -p "../${DEPLOY_DIR}/download"
mkdir -p "../${DEPLOY_DIR}/upload"
mkdir -p "../${DEPLOY_DIR}/img/p"
mkdir -p "../${DEPLOY_DIR}/img/c"

# –°–æ–∑–¥–∞–Ω–∏–µ .htaccess –¥–ª—è production
echo -e "${YELLOW}–°–æ–∑–¥–∞–Ω–∏–µ .htaccess –¥–ª—è production...${NC}"
cat > "../${DEPLOY_DIR}/.htaccess" << 'EOF'
# ~~start~~ Do not remove this comment, Prestashop will keep automatically the code outside this comment when .htaccess will be generated again
# .htaccess automaticaly generated by PrestaShop e-commerce open-source solution
# http://www.prestashop.com - http://www.prestashop.com/forums

<IfModule mod_rewrite.c>
<IfModule mod_env.c>
SetEnv HTTP_MOD_REWRITE On
</IfModule>

RewriteEngine on

# Force HTTPS
RewriteCond %{HTTPS} off
RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]

# Disable MultiViews
Options -MultiViews

# URL rewriting
RewriteRule . - [E=REWRITEBASE:/]
RewriteRule ^api/?(.*)$ %{ENV:REWRITEBASE}webservice/dispatcher.php?url=$1 [QSA,L]

# Redirect –∫ index.php
RewriteCond %{REQUEST_URI} !^/[0-9]+\..+\.cpaneldcv$
RewriteCond %{REQUEST_URI} !^/[A-F0-9]{32}\.txt(?:\ Comodo\ DCV)?$
RewriteCond %{REQUEST_URI} !^/\.well-known/pki-validation/[A-F0-9]{32}\.txt(?:\ Comodo\ DCV)?$
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^(.*)$ %{ENV:REWRITEBASE}index.php [QSA,L]
</IfModule>

# –ó–∞—â–∏—Ç–∞ –æ—Ç SQL –∏–Ω—ä–µ–∫—Ü–∏–π
<IfModule mod_rewrite.c>
RewriteCond %{QUERY_STRING} [a-zA-Z0-9_]=http:// [OR]
RewriteCond %{QUERY_STRING} [a-zA-Z0-9_]=(\.\.//?)+ [OR]
RewriteCond %{QUERY_STRING} [a-zA-Z0-9_]=/([a-z0-9_.]//?)+ [NC]
RewriteRule .* - [F]
</IfModule>

# –ó–∞—â–∏—Ç–∞ —Ñ–∞–π–ª–æ–≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
<FilesMatch "\.(htaccess|htpasswd|ini|log|sh|inc|bak|swp|sql)$">
    Order Allow,Deny
    Deny from all
</FilesMatch>

# GZIP compression
<IfModule mod_deflate.c>
    AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css text/javascript application/javascript application/x-javascript application/json
</IfModule>

# Browser caching
<IfModule mod_expires.c>
    ExpiresActive On
    ExpiresByType image/jpg "access plus 1 year"
    ExpiresByType image/jpeg "access plus 1 year"
    ExpiresByType image/gif "access plus 1 year"
    ExpiresByType image/png "access plus 1 year"
    ExpiresByType image/webp "access plus 1 year"
    ExpiresByType text/css "access plus 1 month"
    ExpiresByType text/javascript "access plus 1 month"
    ExpiresByType application/javascript "access plus 1 month"
    ExpiresByType application/x-javascript "access plus 1 month"
    ExpiresByType application/pdf "access plus 1 month"
    ExpiresByType application/x-shockwave-flash "access plus 1 month"
    ExpiresByType image/x-icon "access plus 1 year"
</IfModule>

# Security headers
<IfModule mod_headers.c>
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-XSS-Protection "1; mode=block"
    Header always set X-Frame-Options "SAMEORIGIN"
</IfModule>

# PHP settings
<IfModule mod_php7.c>
    php_value max_execution_time 500
    php_value max_input_time 500
    php_value memory_limit 128M
    php_value upload_max_filesize 100M
    php_value post_max_size 100M
    php_flag display_errors off
    php_flag log_errors on
</IfModule>

# ~~end~~ Do not remove this comment, Prestashop will keep automatically the code outside this comment when .htaccess will be generated again
EOF

# –°–æ–∑–¥–∞–Ω–∏–µ robots.txt
echo -e "${YELLOW}–°–æ–∑–¥–∞–Ω–∏–µ robots.txt...${NC}"
cat > "../${DEPLOY_DIR}/robots.txt" << 'EOF'
User-agent: *
Disallow: /admin/
Disallow: /admin-dev/
Disallow: /upload/
Disallow: /download/
Disallow: /modules/
Disallow: /cache/
Disallow: /config/
Disallow: /classes/
Disallow: /translations/
Disallow: /login
Disallow: /password
Disallow: /search
Disallow: /cart
Disallow: /my-account
Disallow: /order
Disallow: /*?*
Allow: /modules/*.css
Allow: /modules/*.js
Allow: /modules/*.jpg
Allow: /modules/*.png

Sitemap: https://your-domain.com/sitemap.xml
EOF

# –°–æ–∑–¥–∞–Ω–∏–µ –∞—Ä—Ö–∏–≤–∞
echo -e "${YELLOW}–°–æ–∑–¥–∞–Ω–∏–µ –∞—Ä—Ö–∏–≤–∞ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏...${NC}"
cd "../${DEPLOY_DIR}" || exit
tar -czf "../${DEPLOY_DIR}.tar.gz" .
cd - > /dev/null

# –°–æ–∑–¥–∞–Ω–∏–µ –∞—Ä—Ö–∏–≤–∞ ZIP (–∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞)
cd "../${DEPLOY_DIR}" || exit
zip -r "../${DEPLOY_DIR}.zip" . -q
cd - > /dev/null

# –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ä–∞–∑–º–µ—Ä–µ
TARSIZE=$(du -h "../${DEPLOY_DIR}.tar.gz" | cut -f1)
ZIPSIZE=$(du -h "../${DEPLOY_DIR}.zip" | cut -f1)

echo ""
echo -e "${GREEN}========================================="
echo -e "  –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ!"
echo -e "=========================================${NC}"
echo ""
echo -e "–°–æ–∑–¥–∞–Ω—ã —Å–ª–µ–¥—É—é—â–∏–µ —Ñ–∞–π–ª—ã:"
echo -e "  üìÅ –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: ${YELLOW}../${DEPLOY_DIR}/${NC}"
echo -e "  üì¶ TAR –∞—Ä—Ö–∏–≤: ${YELLOW}../${DEPLOY_DIR}.tar.gz${NC} (${TARSIZE})"
echo -e "  üì¶ ZIP –∞—Ä—Ö–∏–≤: ${YELLOW}../${DEPLOY_DIR}.zip${NC} (${ZIPSIZE})"
echo ""
echo -e "${YELLOW}–°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:${NC}"
echo "  1. –ó–∞–≥—Ä—É–∑–∏—Ç–µ –∞—Ä—Ö–∏–≤ –Ω–∞ —Ö–æ—Å—Ç–∏–Ω–≥ —á–µ—Ä–µ–∑ FTP/SFTP –∏–ª–∏ SSH"
echo "  2. –†–∞—Å–ø–∞–∫—É–π—Ç–µ –∞—Ä—Ö–∏–≤ –≤ –∫–æ—Ä–Ω–µ–≤—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –≤–µ–±-—Å–µ—Ä–≤–µ—Ä–∞"
echo "  3. –°–æ–∑–¥–∞–π—Ç–µ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö MySQL"
echo "  4. –û—Ç–∫—Ä–æ–π—Ç–µ http://your-domain.com/install/ –¥–ª—è –Ω–∞—á–∞–ª–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏"
echo ""
echo -e "${YELLOW}–ö–æ–º–∞–Ω–¥—ã –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ (–ø—Ä–∏–º–µ—Ä—ã):${NC}"
echo ""
echo "  # –ß–µ—Ä–µ–∑ SCP:"
echo "  scp ../${DEPLOY_DIR}.tar.gz user@your-server.com:/var/www/html/"
echo ""
echo "  # –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ —Ä–∞—Å–ø–∞–∫–æ–≤–∞—Ç—å:"
echo "  tar -xzf ${DEPLOY_DIR}.tar.gz"
echo ""
echo -e "${GREEN}–ü–æ–¥—Ä–æ–±–Ω–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –≤ —Ñ–∞–π–ª–µ: DEPLOYMENT_GUIDE_RU.md${NC}"
echo ""

